# Home Assistant Configuration for Smart Water Level Sensor (HTTP) with Multi-Interval Alerts
# This configuration is designed for 2 sensors: 3rd floor and 1st floor tanks
# All entities will be created automatically via HTTP API calls

# Input helpers for calibration (created automatically by ESP32)
# 3rd Floor Tank:
# - input_number.tank_height_tank_3f
# - input_number.empty_distance_tank_3f  
# - input_number.full_distance_tank_3f
# - input_number.tank_diameter_tank_3f
# - input_button.calibrate_sensor_tank_3f

# 1st Floor Tank:
# - input_number.tank_height_tank_1f
# - input_number.empty_distance_tank_1f  
# - input_number.full_distance_tank_1f
# - input_number.tank_diameter_tank_1f
# - input_button.calibrate_sensor_tank_1f

# Alert configuration inputs (created automatically by ESP32):
# 3rd Floor Tank:
# - input_number.low_level_threshold_tank_3f
# - input_number.rapid_leak_threshold_tank_3f (15min)
# - input_number.moderate_leak_threshold_tank_3f (30min)
# - input_number.high_consumption_threshold_tank_3f (1hour)
# - input_number.leak_detection_threshold_tank_3f
# - input_number.alert_cooldown_tank_3f

# 1st Floor Tank:
# - input_number.low_level_threshold_tank_1f
# - input_number.rapid_leak_threshold_tank_1f (15min)
# - input_number.moderate_leak_threshold_tank_1f (30min)
# - input_number.high_consumption_threshold_tank_1f (1hour)
# - input_number.leak_detection_threshold_tank_1f
# - input_number.alert_cooldown_tank_1f

# Optional: Add to your dashboard
# Add this to your Lovelace dashboard configuration
views:
  - title: Water Level Monitoring
    path: water-level
    type: custom:grid-layout
    badges: []
    cards:
      - type: vertical-stack
        cards:
          - type: custom:mini-graph-card
            name: 3rd Floor Tank
            entity: sensor.water_level_3f
            line_color: "#2196F3"
            fill_color: "#2196F3"
            points_per_hour: 20
            hours_to_show: 24
            min: 0
            max: 100
            
          - type: custom:mini-graph-card
            name: 1st Floor Tank
            entity: sensor.water_level_1f
            line_color: "#FF9800"
            fill_color: "#FF9800"
            points_per_hour: 20
            hours_to_show: 24
            min: 0
            max: 100
            
          - type: gauge
            name: 3rd Floor Level
            entity: sensor.water_level_3f
            min: 0
            max: 100
            severity:
              green: 0
              yellow: 20
              red: 10
            
          - type: gauge
            name: 1st Floor Level
            entity: sensor.water_level_1f
            min: 0
            max: 100
            severity:
              green: 0
              yellow: 20
              red: 10
            
          - type: entities
            title: Current Status
            entities:
              - entity: sensor.water_level_3f
                name: 3rd Floor Tank
              - entity: sensor.water_level_1f
                name: 1st Floor Tank
              - type: attribute
                entity: sensor.water_level_3f
                attribute: volume_liters
                name: 3F Volume (L)
              - type: attribute
                entity: sensor.water_level_1f
                attribute: volume_liters
                name: 1F Volume (L)
              - type: attribute
                entity: sensor.water_level_3f
                attribute: consumption_15min_l_15min
                name: 3F 15-Min Consumption (L/15min)
              - type: attribute
                entity: sensor.water_level_1f
                attribute: consumption_15min_l_15min
                name: 1F 15-Min Consumption (L/15min)
              - type: attribute
                entity: sensor.water_level_3f
                attribute: hourly_consumption_l_hour
                name: 3F Hourly Consumption (L/h)
              - type: attribute
                entity: sensor.water_level_1f
                attribute: hourly_consumption_l_hour
                name: 1F Hourly Consumption (L/h)

# Calibration Dashboard
  - title: Tank Calibration
    path: calibration
    type: custom:grid-layout
    badges: []
    cards:
      - type: vertical-stack
        cards:
          - type: entities
            title: 3rd Floor Tank Calibration
            entities:
              - entity: input_number.tank_height_tank_3f
                name: Tank Height
              - entity: input_number.tank_diameter_tank_3f
                name: Tank Diameter
              - entity: input_number.empty_distance_tank_3f
                name: Empty Distance
              - entity: input_number.full_distance_tank_3f
                name: Full Distance
              - entity: input_button.calibrate_sensor_tank_3f
                name: Save Calibration
              
          - type: entities
            title: 1st Floor Tank Calibration
            entities:
              - entity: input_number.tank_height_tank_1f
                name: Tank Height
              - entity: input_number.tank_diameter_tank_1f
                name: Tank Diameter
              - entity: input_number.empty_distance_tank_1f
                name: Empty Distance
              - entity: input_number.full_distance_tank_1f
                name: Full Distance
              - entity: input_button.calibrate_sensor_tank_1f
                name: Save Calibration
              
          - type: markdown
            content: |
              ## Calibration Instructions:
              
              1. **Measure your tank dimensions** and set them above
              2. **Empty your tank** and note the distance reading
              3. **Fill your tank** and note the distance reading
              4. **Set the distances** in the fields above
              5. **Click "Save Calibration"** to apply settings
              
              The sensor will automatically calculate accurate water levels and volumes!

# Alert Monitoring Dashboard
  - title: Alert Monitoring
    path: alerts
    type: custom:grid-layout
    badges: []
    cards:
      - type: vertical-stack
        cards:
          - type: entities
            title: 3rd Floor Alert Thresholds
            entities:
              - entity: input_number.low_level_threshold_tank_3f
                name: Low Level Threshold (%)
              - entity: input_number.rapid_leak_threshold_tank_3f
                name: Rapid Leak Threshold (L/15min)
              - entity: input_number.moderate_leak_threshold_tank_3f
                name: Moderate Leak Threshold (L/30min)
              - entity: input_number.high_consumption_threshold_tank_3f
                name: High Consumption Threshold (L/h)
              - entity: input_number.leak_detection_threshold_tank_3f
                name: Leak Detection Threshold (L/h)
              - entity: input_number.alert_cooldown_tank_3f
                name: Alert Cooldown (minutes)
              
          - type: entities
            title: 1st Floor Alert Thresholds
            entities:
              - entity: input_number.low_level_threshold_tank_1f
                name: Low Level Threshold (%)
              - entity: input_number.rapid_leak_threshold_tank_1f
                name: Rapid Leak Threshold (L/15min)
              - entity: input_number.moderate_leak_threshold_tank_1f
                name: Moderate Leak Threshold (L/30min)
              - entity: input_number.high_consumption_threshold_tank_1f
                name: High Consumption Threshold (L/h)
              - entity: input_number.leak_detection_threshold_tank_1f
                name: Leak Detection Threshold (L/h)
              - entity: input_number.alert_cooldown_tank_1f
                name: Alert Cooldown (minutes)
              
          - type: entities
            title: Current Alerts
            entities:
              - entity: sensor.water_alert_tank_3f
                name: 3rd Floor Alert Status
              - entity: sensor.water_alert_tank_1f
                name: 1st Floor Alert Status
              - type: attribute
                entity: sensor.water_alert_tank_3f
                attribute: alert_message
                name: 3F Alert Message
              - type: attribute
                entity: sensor.water_alert_tank_1f
                attribute: alert_message
                name: 1F Alert Message
              
          - type: custom:mini-graph-card
            name: Multi-Interval Consumption (3rd Floor)
            entities:
              - entity: sensor.water_level_3f
                attribute: consumption_15min_l_15min
                name: 15-Min Consumption
              - entity: sensor.water_level_3f
                attribute: consumption_30min_l_30min
                name: 30-Min Consumption
              - entity: sensor.water_level_3f
                attribute: hourly_consumption_l_hour
                name: Hourly Consumption
            line_color: "#2196F3"
            fill_color: "#2196F3"
            points_per_hour: 4
            hours_to_show: 6
            min: 0
            
          - type: custom:mini-graph-card
            name: Multi-Interval Consumption (1st Floor)
            entities:
              - entity: sensor.water_level_1f
                attribute: consumption_15min_l_15min
                name: 15-Min Consumption
              - entity: sensor.water_level_1f
                attribute: consumption_30min_l_30min
                name: 30-Min Consumption
              - entity: sensor.water_level_1f
                attribute: hourly_consumption_l_hour
                name: Hourly Consumption
            line_color: "#FF9800"
            fill_color: "#FF9800"
            points_per_hour: 4
            hours_to_show: 6
            min: 0

# Automations for alerts and monitoring (2 sensors)
automation:
  # 3rd Floor Tank Automations
  - alias: "Save 3rd Floor Water Level Calibration"
    description: "Save calibration data when 3rd floor calibrate button is pressed"
    trigger:
      platform: state
      entity_id: input_button.calibrate_sensor_tank_3f
      to: "pressed"
    action:
      - service: persistent_notification.create
        data:
          title: "3rd Floor Calibration Saved"
          message: "3rd floor water level sensor calibration has been saved. The sensor will restart to apply new settings."
      - delay: "00:00:02"
      - service: input_button.press
        target:
          entity_id: input_button.calibrate_sensor_tank_3f

  - alias: "3rd Floor Low Water Level Alert"
    description: "Send notification when 3rd floor water level is low"
    trigger:
      platform: state
      entity_id: sensor.water_alert_tank_3f
      to: "low_level"
    action:
      - service: persistent_notification.create
        data:
          title: "🚨 3rd Floor Low Water Level Alert"
          message: "{{ states('sensor.water_alert_tank_3f') }} - 3rd floor water level is critically low!"
      - service: notify.mobile_app
        data:
          title: "🚨 3rd Floor Low Water Level"
          message: "3rd floor water level is at {{ states('sensor.water_level_3f') }}% - Please check your tank!"

  - alias: "3rd Floor Rapid Leak Alert (15min)"
    description: "Send urgent notification for 3rd floor rapid leak detection"
    trigger:
      platform: state
      entity_id: sensor.water_alert_tank_3f
      to: "rapid_leak"
    action:
      - service: persistent_notification.create
        data:
          title: "🚨 3rd Floor RAPID LEAK DETECTED!"
          message: "{{ states('sensor.water_alert_tank_3f') }} - Critical leak detected in 3rd floor tank in 15 minutes!"
      - service: notify.mobile_app
        data:
          title: "🚨 3rd Floor RAPID LEAK DETECTED!"
          message: "3rd floor critical leak: {{ states('sensor.water_level_3f') | attr('consumption_15min_l_15min') }} L/15min - CHECK IMMEDIATELY!"

  - alias: "3rd Floor Moderate Leak Alert (30min)"
    description: "Send notification for 3rd floor moderate leak detection"
    trigger:
      platform: state
      entity_id: sensor.water_alert_tank_3f
      to: "moderate_leak"
    action:
      - service: persistent_notification.create
        data:
          title: "⚠️ 3rd Floor MODERATE LEAK DETECTED"
          message: "{{ states('sensor.water_alert_tank_3f') }} - Moderate leak detected in 3rd floor tank in 30 minutes!"
      - service: notify.mobile_app
        data:
          title: "⚠️ 3rd Floor MODERATE LEAK DETECTED"
          message: "3rd floor moderate leak: {{ states('sensor.water_level_3f') | attr('consumption_30min_l_30min') }} L/30min - Check soon!"

  # 1st Floor Tank Automations
  - alias: "Save 1st Floor Water Level Calibration"
    description: "Save calibration data when 1st floor calibrate button is pressed"
    trigger:
      platform: state
      entity_id: input_button.calibrate_sensor_tank_1f
      to: "pressed"
    action:
      - service: persistent_notification.create
        data:
          title: "1st Floor Calibration Saved"
          message: "1st floor water level sensor calibration has been saved. The sensor will restart to apply new settings."
      - delay: "00:00:02"
      - service: input_button.press
        target:
          entity_id: input_button.calibrate_sensor_tank_1f

  - alias: "1st Floor Low Water Level Alert"
    description: "Send notification when 1st floor water level is low"
    trigger:
      platform: state
      entity_id: sensor.water_alert_tank_1f
      to: "low_level"
    action:
      - service: persistent_notification.create
        data:
          title: "🚨 1st Floor Low Water Level Alert"
          message: "{{ states('sensor.water_alert_tank_1f') }} - 1st floor water level is critically low!"
      - service: notify.mobile_app
        data:
          title: "🚨 1st Floor Low Water Level"
          message: "1st floor water level is at {{ states('sensor.water_level_1f') }}% - Please check your tank!"

  - alias: "1st Floor Rapid Leak Alert (15min)"
    description: "Send urgent notification for 1st floor rapid leak detection"
    trigger:
      platform: state
      entity_id: sensor.water_alert_tank_1f
      to: "rapid_leak"
    action:
      - service: persistent_notification.create
        data:
          title: "🚨 1st Floor RAPID LEAK DETECTED!"
          message: "{{ states('sensor.water_alert_tank_1f') }} - Critical leak detected in 1st floor tank in 15 minutes!"
      - service: notify.mobile_app
        data:
          title: "🚨 1st Floor RAPID LEAK DETECTED!"
          message: "1st floor critical leak: {{ states('sensor.water_level_1f') | attr('consumption_15min_l_15min') }} L/15min - CHECK IMMEDIATELY!"

  - alias: "1st Floor Moderate Leak Alert (30min)"
    description: "Send notification for 1st floor moderate leak detection"
    trigger:
      platform: state
      entity_id: sensor.water_alert_tank_1f
      to: "moderate_leak"
    action:
      - service: persistent_notification.create
        data:
          title: "⚠️ 1st Floor MODERATE LEAK DETECTED"
          message: "{{ states('sensor.water_alert_tank_1f') }} - Moderate leak detected in 1st floor tank in 30 minutes!"
      - service: notify.mobile_app
        data:
          title: "⚠️ 1st Floor MODERATE LEAK DETECTED"
          message: "1st floor moderate leak: {{ states('sensor.water_level_1f') | attr('consumption_30min_l_30min') }} L/30min - Check soon!"

  # Combined Daily Report
  - alias: "Daily Water Consumption Report (Both Tanks)"
    description: "Send daily water consumption summary for both tanks"
    trigger:
      platform: time
      at: "08:00:00"
    condition:
      - condition: or
        conditions:
          - condition: numeric_state
            entity_id: sensor.water_level_3f
            attribute: daily_consumption_l_day
            above: 0
          - condition: numeric_state
            entity_id: sensor.water_level_1f
            attribute: daily_consumption_l_day
            above: 0
    action:
      - service: notify.mobile_app
        data:
          title: "📊 Daily Water Report"
          message: |
            3rd Floor:
            - Yesterday's consumption: {{ states('sensor.water_level_3f') | attr('daily_consumption_l_day') | round(1) }} L
            - Current level: {{ states('sensor.water_level_3f') }}%
            - Average daily: {{ states('sensor.water_level_3f') | attr('average_daily_consumption_l_day') | round(1) }} L
            
            1st Floor:
            - Yesterday's consumption: {{ states('sensor.water_level_1f') | attr('daily_consumption_l_day') | round(1) }} L
            - Current level: {{ states('sensor.water_level_1f') }}%
            - Average daily: {{ states('sensor.water_level_1f') | attr('average_daily_consumption_l_day') | round(1) }} L

# Template sensors for additional calculations (2 sensors)
template:
  - sensor:
      # 3rd Floor Tank Template Sensors
      - name: "3rd Floor Days Until Empty"
        unique_id: "water_days_until_empty_3f"
        state: >
          {% set current_level = states('sensor.water_level_3f') | float %}
          {% set daily_usage = states('sensor.water_level_3f') | attr('average_daily_consumption_l_day') | float %}
          {% if daily_usage > 0 and current_level > 0 %}
            {% set current_volume = states('sensor.water_level_3f') | attr('volume_liters') | float %}
            {{ (current_volume / daily_usage) | round(1) }}
          {% else %}
            0
          {% endif %}
        unit_of_measurement: "days"
        device_class: "duration"
        
      - name: "3rd Floor Water Usage Trend"
        unique_id: "water_usage_trend_3f"
        state: >
          {% set current_usage = states('sensor.water_level_3f') | attr('hourly_consumption_l_hour') | float %}
          {% set avg_usage = states('sensor.water_level_3f') | attr('average_daily_consumption_l_day') | float / 24 %}
          {% if avg_usage > 0 %}
            {% if current_usage > avg_usage * 1.5 %}
              High
            {% elif current_usage < avg_usage * 0.5 %}
              Low
            {% else %}
              Normal
            {% endif %}
          {% else %}
            Normal
          {% endif %}
        device_class: "enum"
        
      - name: "3rd Floor Leak Severity"
        unique_id: "water_leak_severity_3f"
        state: >
          {% set rapid_leak = states('sensor.water_level_3f') | attr('consumption_15min_l_15min') | float %}
          {% set moderate_leak = states('sensor.water_level_3f') | attr('consumption_30min_l_30min') | float %}
          {% set rapid_threshold = states('input_number.rapid_leak_threshold_tank_3f') | float %}
          {% set moderate_threshold = states('input_number.moderate_leak_threshold_tank_3f') | float %}
          {% if rapid_leak > rapid_threshold %}
            Critical
          {% elif moderate_leak > moderate_threshold %}
            Moderate
          {% else %}
            None
          {% endif %}
        device_class: "enum"
        
      # 1st Floor Tank Template Sensors
      - name: "1st Floor Days Until Empty"
        unique_id: "water_days_until_empty_1f"
        state: >
          {% set current_level = states('sensor.water_level_1f') | float %}
          {% set daily_usage = states('sensor.water_level_1f') | attr('average_daily_consumption_l_day') | float %}
          {% if daily_usage > 0 and current_level > 0 %}
            {% set current_volume = states('sensor.water_level_1f') | attr('volume_liters') | float %}
            {{ (current_volume / daily_usage) | round(1) }}
          {% else %}
            0
          {% endif %}
        unit_of_measurement: "days"
        device_class: "duration"
        
      - name: "1st Floor Water Usage Trend"
        unique_id: "water_usage_trend_1f"
        state: >
          {% set current_usage = states('sensor.water_level_1f') | attr('hourly_consumption_l_hour') | float %}
          {% set avg_usage = states('sensor.water_level_1f') | attr('average_daily_consumption_l_day') | float / 24 %}
          {% if avg_usage > 0 %}
            {% if current_usage > avg_usage * 1.5 %}
              High
            {% elif current_usage < avg_usage * 0.5 %}
              Low
            {% else %}
              Normal
            {% endif %}
          {% else %}
            Normal
          {% endif %}
        device_class: "enum"
        
      - name: "1st Floor Leak Severity"
        unique_id: "water_leak_severity_1f"
        state: >
          {% set rapid_leak = states('sensor.water_level_1f') | attr('consumption_15min_l_15min') | float %}
          {% set moderate_leak = states('sensor.water_level_1f') | attr('consumption_30min_l_30min') | float %}
          {% set rapid_threshold = states('input_number.rapid_leak_threshold_tank_1f') | float %}
          {% set moderate_threshold = states('input_number.moderate_leak_threshold_tank_1f') | float %}
          {% if rapid_leak > rapid_threshold %}
            Critical
          {% elif moderate_leak > moderate_threshold %}
            Moderate
          {% else %}
            None
          {% endif %}
        device_class: "enum"

# Configuration Notes:
# This configuration is designed for 2 sensors: 3rd floor and 1st floor tanks
# All entity names follow the pattern: [entity_type].[name]_tank_[location]
# - 3rd floor: tank_3f
# - 1st floor: tank_1f

# HTTP Setup Instructions:
# 1. Create a Long-Lived Access Token in Home Assistant:
#    - Go to your profile in Home Assistant
#    - Scroll down to "Long-Lived Access Tokens"
#    - Create a new token with a descriptive name
#    - Copy the token (you'll only see it once)
#
# 2. Update the ESP32 code with your settings:
#    - homeAssistantUrl: Your Home Assistant domain (e.g., "https://domain.com")
#    - accessToken: Your long-lived access token
#    - sensorEntityId: The entity ID for the sensor (e.g., "sensor.water_level_3f" for 3rd floor)
#
# 3. Upload the code to your ESP32
#
# 4. The sensors and all entities will be created automatically in Home Assistant
#    - 3rd Floor Entity ID: sensor.water_level_3f
#    - 1st Floor Entity ID: sensor.water_level_1f
#    - Shows water level as percentage with volume calculation
#    - Includes multi-interval consumption monitoring and alert system

# Multi-Interval Monitoring Features:
# - 15-minute rapid leak detection (most sensitive)
# - 30-minute moderate leak detection (balanced)
# - 1-hour consumption monitoring (standard)
# - 24-hour daily consumption tracking
# - Configurable thresholds for each interval
# - Different alert priorities based on time intervals
# - Mobile notifications with appropriate urgency levels
# - Real-time consumption graphs for all intervals
# - Leak severity classification

# Alert Priority Levels:
# 🚨 CRITICAL: Rapid leak (15min) - Immediate action required
# ⚠️ MODERATE: Moderate leak (30min) - Check soon
# ⚠️ HIGH: High consumption (1hour) - Monitor usage
# 🚨 URGENT: Low water level - Refill needed

# Security Benefits of HTTP over MQTT:
# - No MQTT broker needed
# - Uses Home Assistant's built-in authentication
# - Access tokens can be revoked easily
# - No additional network services exposed
# - Simpler firewall configuration
# - Uses standard HTTPS/HTTP ports

# Troubleshooting:
# - Check serial monitor for HTTP response codes
# - Verify Home Assistant URL is accessible from ESP32
# - Ensure access token is valid and not expired
# - Check Home Assistant logs for API errors
# - Verify entity ID doesn't conflict with existing sensors
# - All entities should appear automatically after first upload 